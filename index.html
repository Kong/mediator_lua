<!doctype html>
<html>
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="chrome=1">
    <title>Mediator lua by Olivine-Labs</title>

    <link rel="stylesheet" href="stylesheets/styles.css">
    <link rel="stylesheet" href="stylesheets/pygment_trac.css">
    <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">
    <!--[if lt IE 9]>
    <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
  </head>
  <body>
    <div class="wrapper">
      <header>
        <h1>Mediator lua</h1>
        <p>Event Management for Clean &amp; Decoupled Code</p>

        <p class="view"><a href="https://github.com/Olivine-Labs/mediator_lua">View the Project on GitHub <small>Olivine-Labs/mediator_lua</small></a></p>


        <ul>
          <li><a href="https://github.com/Olivine-Labs/mediator_lua/zipball/master">Download <strong>ZIP File</strong></a></li>
          <li><a href="https://github.com/Olivine-Labs/mediator_lua/tarball/master">Download <strong>TAR Ball</strong></a></li>
          <li><a href="https://github.com/Olivine-Labs/mediator_lua">View On <strong>GitHub</strong></a></li>
        </ul>
      </header>
      <section>
        <h1>mediator_lua</h1>

<p>Version 1.0</p>

<p>For more information, please see </p>

<p><a href="https://github.com/OlivineLabs/mediator_lua">View the project on Github</a></p>

<p><a href="http://olivinelabs.com/mediator_lua">View the documentation</a></p>

<p>If you have <a href="http://luarocks.org">luarocks</a>, isntall it with <code>luarocks install mediator_lua</code>.
If you don't, get it. If you really don't want to, just copy mediator.lua from the 
<a href="https://github.com/OlivineLabs/mediator_lua">Git repository</a>.</p>

<h2>A utility class to help you manage events.</h2>

<p>mediator_lua is a simple class that allows you to listen to events by subscribing to
and sending data to channels. Its purpose is to help you decouple code where you
might otherwise have functions calling functions calling functions, and instead
simply call <code>mediator.publish("chat", { message = "hi" })</code></p>

<h2>Why?</h2>

<p>My specific use case: manage HTTP routes called in OpenResty. There's an excellent 
article that talks about the Mediator pattern (in Javascript) in more in detail by 
<a href="http://addyosmani.com/largescalejavascript/#mediatorpattern">Addy Osmani</a>
(that made me go back and refactor this code a bit.)</p>

<h2>Usage</h2>

<p>You can register events with the mediator two ways: using channels, or with a 
<em>predicate</em> to perform more complex matching (a predicate is a function that
returns a true/false value that determines if mediator should run the callback.) </p>

<p>Instantiate a new mediator, and then you can being subscribing, removing, and publishing.</p>

<p>Example:</p>

<div class="highlight"><pre><span class="n">Mediator</span> <span class="o">=</span> <span class="nb">require</span> <span class="s2">"</span><span class="s">mediator_lua"</span>
<span class="n">mediator</span> <span class="o">=</span> <span class="n">Mediator</span><span class="p">()</span> <span class="o">#</span> <span class="n">instantiate</span> <span class="n">a</span> <span class="n">new</span> <span class="n">mediator</span>

<span class="n">mediator</span><span class="p">:</span><span class="n">publish</span><span class="p">(</span><span class="n">channel</span><span class="p">,</span> <span class="o">&lt;</span><span class="n">data</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="o">...</span> <span class="o">&gt;</span><span class="p">)</span>
<span class="n">mediator</span><span class="p">:</span><span class="n">remove</span><span class="p">(</span><span class="o">&lt;</span><span class="n">channel</span><span class="o">&gt;</span><span class="p">)</span> 
</pre></div>

<p>Subscription signature:</p>

<div class="highlight"><pre><span class="p">(</span><span class="n">channel</span><span class="p">,</span> <span class="n">callback</span><span class="p">,</span> <span class="o">&lt;</span><span class="n">options</span><span class="o">&gt;</span><span class="p">,</span> <span class="o">&lt;</span><span class="n">context</span><span class="o">&gt;</span><span class="p">);</span>
</pre></div>

<p>Callback signature:</p>

<div class="highlight"><pre><span class="k">function</span><span class="p">(</span><span class="o">&lt;</span><span class="n">data</span><span class="p">,</span> <span class="n">data</span> <span class="o">...&gt;</span><span class="p">,</span> <span class="n">channel</span><span class="p">);</span>
</pre></div>

<p>Mediator:subscribe <code>options</code> (all are optional; default is empty):</p>

<div class="highlight"><pre><span class="p">{</span>
  <span class="n">predicate</span> <span class="o">=</span> <span class="k">function</span><span class="p">(</span><span class="n">arg1</span><span class="p">,</span> <span class="n">arg2</span><span class="p">)</span> <span class="k">return</span> <span class="n">arg1</span> <span class="o">==</span> <span class="n">arg2</span> <span class="k">end</span>
  <span class="n">priority</span> <span class="o">=</span> <span class="mi">0</span><span class="err">|</span><span class="mi">1</span><span class="err">|</span><span class="o">...</span> <span class="p">(</span><span class="n">array</span> <span class="n">index</span><span class="p">;</span> <span class="n">max</span> <span class="n">of</span> <span class="n">callback</span> <span class="n">array</span> <span class="n">length</span><span class="p">,</span> <span class="n">min</span> <span class="n">of</span> <span class="mi">0</span><span class="p">)</span>
<span class="p">}</span>
</pre></div>

<p>When you call <code>subscribe</code>, you get a <code>subscriber</code> object back that you can use to
update and change options. It looks like:</p>

<div class="highlight"><pre><span class="p">{</span>
  <span class="n">id</span><span class="p">,</span> <span class="o">#</span> <span class="n">unique</span> <span class="n">identifier</span>
  <span class="n">fn</span><span class="p">,</span> <span class="o">#</span> <span class="k">function</span> <span class="nf">you</span> <span class="n">passed</span> <span class="k">in</span>
  <span class="n">options</span><span class="p">,</span> <span class="o">#</span> <span class="n">options</span>
  <span class="n">context</span><span class="p">,</span> <span class="o">#</span> <span class="n">context</span> <span class="k">for</span> <span class="n">fn</span> <span class="n">to</span> <span class="n">be</span> <span class="n">called</span> <span class="n">within</span>
  <span class="n">channel</span><span class="p">,</span> <span class="o">#</span> <span class="n">provides</span> <span class="n">a</span> <span class="n">pointer</span> <span class="n">back</span> <span class="n">to</span> <span class="n">its</span> <span class="n">channel</span>
  <span class="n">update</span><span class="p">(</span><span class="n">options</span><span class="p">)</span> <span class="o">#</span> <span class="k">function</span> <span class="nf">that</span> <span class="n">accepts</span> <span class="p">{</span> <span class="n">fn</span><span class="p">,</span> <span class="n">options</span><span class="p">,</span> <span class="n">context</span> <span class="p">}</span>
<span class="p">}</span>
</pre></div>

<p>Examples:</p>

<div class="highlight"><pre><span class="n">Mediator</span> <span class="o">=</span> <span class="nb">require</span><span class="p">(</span><span class="s2">"</span><span class="s">mediator_lua"</span><span class="p">)</span>
<span class="kd">local</span> <span class="n">mediator</span> <span class="o">=</span> <span class="n">Mediator</span><span class="p">()</span>

<span class="o">#</span> <span class="n">Print</span> <span class="n">data</span> <span class="n">when</span> <span class="n">the</span> <span class="s2">"</span><span class="s">message"</span> <span class="n">channel</span> <span class="n">is</span> <span class="n">published</span> <span class="n">to</span>
<span class="o">#</span> <span class="n">Subscribe</span> <span class="n">returns</span> <span class="n">a</span> <span class="s2">"</span><span class="s">Subscriber"</span> <span class="n">object</span>
<span class="n">mediator</span><span class="p">:</span><span class="n">subscribe</span><span class="p">(</span><span class="s2">"</span><span class="s">message"</span><span class="p">,</span> <span class="k">function</span><span class="p">(</span><span class="n">data</span><span class="p">)</span> <span class="nb">print</span><span class="p">(</span><span class="n">data</span><span class="p">)</span> <span class="k">end</span><span class="p">);</span>
<span class="n">mediator</span><span class="p">:</span><span class="n">publish</span><span class="p">(</span><span class="s2">"</span><span class="s">message"</span><span class="p">,</span> <span class="s2">"</span><span class="s">Hello, world"</span><span class="p">);</span>

  <span class="o">&gt;&gt;</span> <span class="n">Hello</span><span class="p">,</span> <span class="n">world</span>

<span class="o">#</span> <span class="n">Print</span> <span class="n">the</span> <span class="n">message</span> <span class="n">when</span> <span class="n">the</span> <span class="n">predicate</span> <span class="k">function</span> <span class="nf">returns</span> <span class="kc">true</span>
<span class="kd">local</span> <span class="n">predicate</span> <span class="o">=</span> <span class="k">function</span><span class="p">(</span><span class="n">data</span><span class="p">)</span> <span class="k">return</span> <span class="n">data</span><span class="p">.</span><span class="n">From</span> <span class="o">==</span> <span class="s2">"</span><span class="s">Jack"</span> <span class="k">end</span>
<span class="n">mediator</span><span class="p">.</span><span class="n">Subscribe</span><span class="p">(</span><span class="s2">"</span><span class="s">channel"</span><span class="p">,</span> <span class="k">function</span><span class="p">(</span><span class="n">data</span><span class="p">)</span> <span class="nb">print</span><span class="p">(</span><span class="n">data</span><span class="p">.</span><span class="n">Message</span><span class="p">)</span> <span class="k">end</span><span class="p">,</span> <span class="p">{</span> <span class="n">predicate</span> <span class="o">=</span> <span class="n">predicate</span> <span class="p">});</span>
<span class="n">mediator</span><span class="p">.</span><span class="n">Publish</span><span class="p">(</span><span class="s2">"</span><span class="s">channel"</span><span class="p">,</span> <span class="p">{</span> <span class="n">Message</span> <span class="o">=</span> <span class="s2">"</span><span class="s">Hey!"</span><span class="p">,</span> <span class="n">From</span> <span class="o">=</span> <span class="s2">"</span><span class="s">Jack"</span> <span class="p">})</span>
<span class="n">mediator</span><span class="p">.</span><span class="n">Publish</span><span class="p">(</span><span class="s2">"</span><span class="s">channel"</span><span class="p">,</span> <span class="p">{</span> <span class="n">Message</span> <span class="o">=</span> <span class="s2">"</span><span class="s">Hey!"</span><span class="p">,</span> <span class="n">From</span> <span class="o">=</span> <span class="s2">"</span><span class="s">Drew"</span> <span class="p">})</span>

  <span class="o">&gt;&gt;</span> <span class="n">Hey</span><span class="err">!</span>
</pre></div>

<p>You can remove events by passing in a type or predicate, and optionally the 
function to remove.</p>

<div class="highlight"><pre><span class="o">#</span> <span class="n">removes</span> <span class="n">all</span> <span class="n">methods</span> <span class="n">bound</span> <span class="n">to</span> <span class="n">a</span> <span class="n">channel</span> 
<span class="n">mediator</span><span class="p">:</span><span class="n">remove</span><span class="p">(</span><span class="s2">"</span><span class="s">channel"</span><span class="p">)</span>

<span class="o">#</span> <span class="n">unregisters</span> <span class="n">MethodFN</span><span class="p">,</span> <span class="n">a</span> <span class="n">named</span> <span class="k">function</span> <span class="nf">we</span> <span class="n">defined</span> <span class="n">elsewhere</span><span class="p">,</span> <span class="n">from</span> <span class="s2">"</span><span class="s">channel"</span> 
<span class="n">mediator</span><span class="p">:</span><span class="n">remove</span><span class="p">(</span><span class="s2">"</span><span class="s">channel"</span><span class="p">,</span> <span class="n">MethodFN</span><span class="p">)</span>
</pre></div>

<p>You can call the registered functions with the <code>publish</code> method, which accepts 
an args array:</p>

<div class="highlight"><pre><span class="n">mediator</span><span class="p">:</span><span class="n">publish</span><span class="p">(</span><span class="s2">"</span><span class="s">channel"</span><span class="p">,</span> <span class="s2">"</span><span class="s">argument"</span><span class="p">,</span> <span class="s2">"</span><span class="s">another one"</span><span class="p">,</span> <span class="p">{</span> <span class="n">etc</span><span class="p">:</span> <span class="kc">true</span> <span class="p">});</span> <span class="o">#</span> <span class="n">args</span> <span class="n">go</span> <span class="n">on</span> <span class="n">forever</span>
</pre></div>

<p>You can namespace your subscribing / removing / publishing. This will recurisevely
call children, and also subscribers to direct parents.</p>

<div class="highlight"><pre><span class="n">mediator</span><span class="p">:</span><span class="n">subscribe</span><span class="p">(</span><span class="s2">"</span><span class="s">application:chat:receiveMessage"</span><span class="p">,</span> <span class="k">function</span><span class="p">(</span><span class="n">data</span><span class="p">){</span> <span class="o">...</span> <span class="p">})</span>

<span class="o">#</span> <span class="n">will</span> <span class="n">recursively</span> <span class="n">call</span> <span class="n">anything</span> <span class="k">in</span> <span class="n">the</span> <span class="n">appllication</span><span class="p">:</span><span class="n">chat</span><span class="p">:</span><span class="n">receiveMessage</span> <span class="n">namespace</span> 
<span class="o">#</span> <span class="n">will</span> <span class="n">also</span> <span class="n">call</span> <span class="n">thins</span> <span class="n">directly</span> <span class="n">subscribed</span> <span class="n">to</span> <span class="n">application</span> <span class="ow">and</span> <span class="n">application</span><span class="p">:</span><span class="n">chat</span><span class="p">,</span>
<span class="o">#</span> <span class="n">but</span> <span class="ow">not</span> <span class="n">their</span> <span class="n">children</span>
<span class="n">mediator</span><span class="p">:</span><span class="n">publish</span><span class="p">(</span><span class="s2">"</span><span class="s">application:chat:receiveMessage"</span><span class="p">,</span> <span class="s2">"</span><span class="s">Jack Lawson"</span><span class="p">,</span> <span class="s2">"</span><span class="s">Hey"</span><span class="p">)</span>

<span class="o">#</span> <span class="n">will</span> <span class="n">recursively</span> <span class="n">remove</span> <span class="n">everything</span> <span class="n">under</span> <span class="n">application</span><span class="p">:</span><span class="n">chat</span>
<span class="n">mediator</span><span class="p">:</span><span class="n">remove</span><span class="p">(</span><span class="s2">"</span><span class="s">application:chat"</span><span class="p">)</span>
</pre></div>

<p>You can update Subscriber priority:</p>

<div class="highlight"><pre><span class="kd">local</span> <span class="n">sub</span> <span class="o">=</span> <span class="n">mediator</span><span class="p">:</span><span class="n">subscribe</span><span class="p">(</span><span class="s2">"</span><span class="s">application:chat"</span><span class="p">,</span> <span class="k">function</span><span class="p">(</span><span class="n">data</span><span class="p">){</span> <span class="o">...</span> <span class="p">})</span>
<span class="kd">local</span> <span class="n">sub2</span> <span class="o">=</span> <span class="n">mediator</span><span class="p">:</span><span class="n">subscribe</span><span class="p">(</span><span class="s2">"</span><span class="s">application:chat"</span><span class="p">,</span> <span class="k">function</span><span class="p">(</span><span class="n">data</span><span class="p">){</span> <span class="o">...</span> <span class="p">})</span>

<span class="o">#</span> <span class="n">have</span> <span class="n">sub2</span> <span class="n">executed</span> <span class="n">first</span>
<span class="n">mediator</span><span class="p">.</span><span class="n">GetChannel</span><span class="p">(</span><span class="s2">"</span><span class="s">application:chat"</span><span class="p">).</span><span class="n">SetPriority</span><span class="p">(</span><span class="n">sub2</span><span class="p">.</span><span class="n">id</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
</pre></div>

<p>You can update Subscriber callback, context, and/or options:</p>

<div class="highlight"><pre><span class="n">sub</span><span class="p">:</span><span class="n">update</span><span class="p">({</span> <span class="n">fn</span><span class="p">:</span> <span class="o">...</span><span class="p">,</span> <span class="n">context</span> <span class="o">=</span> <span class="p">{</span> <span class="p">},</span> <span class="n">options</span> <span class="o">=</span> <span class="p">{</span> <span class="o">...</span> <span class="p">})</span>
</pre></div>

<p>You can stop the chain of execution by calling channel:stopPropagation()</p>

<div class="highlight"><pre><span class="o">#</span> <span class="k">for</span> <span class="n">example</span><span class="p">,</span> <span class="n">let</span><span class="s1">'</span><span class="s">s not post the message if the `from` and `to` are the same</span>
<span class="n">mediator</span><span class="p">.</span><span class="n">Subscribe</span><span class="p">(</span><span class="s2">"</span><span class="s">application:chat"</span><span class="p">,</span> <span class="k">function</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">channel</span><span class="p">)</span> 
  <span class="o">#</span> <span class="n">throw</span> <span class="n">an</span> <span class="nb">error</span> <span class="n">message</span> <span class="ow">or</span> <span class="n">something</span>
  <span class="n">channel</span><span class="p">:</span><span class="n">stopPropagation</span><span class="p">()</span>
<span class="k">end</span><span class="p">,</span> <span class="n">options</span> <span class="o">=</span> <span class="p">{</span>
  <span class="n">predicate</span> <span class="o">=</span> <span class="k">function</span><span class="p">(</span><span class="n">data</span><span class="p">)</span> <span class="k">return</span> <span class="n">data</span><span class="p">.</span><span class="n">From</span> <span class="o">==</span> <span class="n">data</span><span class="p">.</span><span class="n">To</span> <span class="k">end</span><span class="p">,</span>
  <span class="n">priority</span> <span class="o">=</span> <span class="mi">0</span>
<span class="p">})</span>
</pre></div>

<h2>Testing</h2>

<p>Uses <a href="http://www.nessie.de/mroth/lunit/">lunit</a> for testing; you can install it
through <a href="http://luarocks.org">luarocks</a>.</p>

<h2>Contributing</h2>

<p>Build stuff, run the tests, then submit a pull request with comments and a
description of what you've done, and why.</p>

<h2>License</h2>

<p>This code and its accompanying README and are 
<a href="http://www.opensource.org/licenses/mit-license.php">MIT licensed</a>. </p>

<h2>In Closing</h2>

<p>Have fun, and please submit suggestions and improvements! You can leave any 
issues here, or contact me on Twitter (<a href="https://github.com/ajacksified" class="user-mention">@ajacksified</a>).</p>
      </section>
      <footer>
        <p>This project is maintained by <a href="https://github.com/Olivine-Labs">Olivine-Labs</a></p>
        <p><small>Hosted on GitHub Pages &mdash; Theme by <a href="https://github.com/orderedlist">orderedlist</a></small></p>
      </footer>
    </div>
    <script src="javascripts/scale.fix.js"></script>
              <script type="text/javascript">
            var gaJsHost = (("https:" == document.location.protocol) ? "https://ssl." : "http://www.");
            document.write(unescape("%3Cscript src='" + gaJsHost + "google-analytics.com/ga.js' type='text/javascript'%3E%3C/script%3E"));
          </script>
          <script type="text/javascript">
            try {
              var pageTracker = _gat._getTracker("UA-22050912-1");
            pageTracker._trackPageview();
            } catch(err) {}
          </script>

  </body>
</html>